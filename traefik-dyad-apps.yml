# Traefik Configuration for Dyad App Subdomains
# File: /data/coolify/proxy/dynamic/dyad-apps.yml

http:
  routers:
    dyad-apps:
      # Match subdomains like app-dyad-72.ty-dev.site OR app-dyad-72.dyad1.ty-dev.site
      rule: "HostRegexp(`{subdomain:app-dyad-[0-9]+}.ty-dev.site`) || HostRegexp(`{subdomain:app-dyad-[0-9]+}.dyad1.ty-dev.site`)"
      entryPoints:
        - https
      service: dyad-apps-service
      tls: {}
      # Cloudflare handles SSL termination, so we don't need a certResolver here.
      # If you were using Let's Encrypt directly, you would uncomment:
      # certResolver: letsencrypt

    # WebSocket Router for Main Domain (Terminal/Chat)
    dyad-ws:
      rule: "Host(`dyad1.ty-dev.site`) && PathPrefix(`/ws/`)"
      priority: 1000
      entryPoints:
        - https
      service: dyad-apps-service
      tls: {}

  services:
    dyad-apps-service:
      loadBalancer:
        servers:
          # Point directly to Node.js backend (Middleware in index.ts handles routing)
          - url: "http://dyad-web:3007"

  middlewares:
    dyad-apps-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          Access-Control-Allow-Origin: "*"
          Access-Control-Allow-Methods: "GET,POST,PUT,DELETE,OPTIONS"
          Access-Control-Allow-Headers: "Content-Type,Authorization"
