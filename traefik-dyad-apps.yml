# Traefik Configuration for Dyad App Subdomains (TLS OnDemand)
# File: /data/coolify/proxy/dynamic/dyad-apps.yml

http:
  routers:
    dyad-apps:
      # Match subdomains like app-dyad-72.dyad1.ty-dev.site (flat structure)
      rule: "HostRegexp(`{subdomain:app-dyad-[0-9]+}.dyad1.ty-dev.site`) || HostRegexp(`{subdomain:app-dyad-[0-9]+}.ty-dev.site`)"
      entryPoints:
        - https
      service: dyad-apps-service
      tls:
        certResolver: letsencrypt
        # options: ondemand (Removed for Cloudflare Universal SSL compatibility)

  services:
    dyad-apps-service:
      loadBalancer:
        servers:
          # Point to Nginx container which handles the subdomain logic
          - url: "http://dyad-nginx:80"

  middlewares:
    dyad-apps-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          Access-Control-Allow-Origin: "*"
          Access-Control-Allow-Methods: "GET,POST,PUT,DELETE,OPTIONS"
          Access-Control-Allow-Headers: "Content-Type,Authorization"

tls:
  options:
    ondemand:
      onDemand:
        # Ask allows Traefik to check if it should issue a cert.
        # Ideally enable this and point to an API: http://dyad-server:3007/api/check-domain
        # For now, commented out to ensure it works immediately (but less secure against spam)
        # ask: http://dyad-server:3007/api/allow-cert
