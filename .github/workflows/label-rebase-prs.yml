name: Label PRs needing rebase

on:
  push:
    branches: [main]

permissions:
  pull-requests: write

jobs:
  label-conflicting-prs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const allowedAuthors = ['wwwillchen', 'wwwillchen-bot'];

            const prs = await github.paginate(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
            });

            for (const pr of prs) {
              if (!allowedAuthors.includes(pr.user.login)) continue;
              if (pr.draft) continue;

              // mergeable status requires an individual GET call
              const { data: detail } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              });

              // GitHub may not have computed mergeability yet (null).
              // A short wait + retry handles the common case.
              let mergeable = detail.mergeable;
              if (mergeable === null) {
                await new Promise(r => setTimeout(r, 3000));
                const { data: retry } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                });
                mergeable = retry.mergeable;
              }

              if (mergeable === false) {
                const labels = detail.labels.map(l => l.name);
                // Don't add if already labeled or actively rebasing
                if (labels.includes('cc:rebase') || labels.includes('cc:rebasing')) {
                  console.log(`PR #${pr.number} already has rebase label, skipping`);
                  continue;
                }
                console.log(`Adding cc:rebase to PR #${pr.number}: ${pr.title}`);
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['cc:rebase'],
                });
              } else {
                console.log(`PR #${pr.number} is mergeable (${mergeable}), skipping`);
              }
            }
