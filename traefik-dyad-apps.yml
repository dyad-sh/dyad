# Traefik Configuration for Dyad App Subdomains (TLS OnDemand)
# File: /data/coolify/proxy/dynamic/dyad-apps.yml

http:
  routers:
    dyad-apps:
      # Match subdomains like app72.dyad1.ty-dev.site
      rule: "HostRegexp(`{subdomain:app[0-9]+}.dyad1.ty-dev.site`)"
      entryPoints:
        - https
      service: dyad-apps-service
      tls:
        certResolver: letsencrypt
        # Use OnDemand option defined below instead of Wildcard
        options: ondemand

  services:
    dyad-apps-service:
      loadBalancer:
        servers:
          # Container name 'dyad-server' and Port 3001 based on docker-compose.yml
          - url: "http://dyad-server:3001"

  middlewares:
    dyad-apps-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          Access-Control-Allow-Origin: "*"
          Access-Control-Allow-Methods: "GET,POST,PUT,DELETE,OPTIONS"
          Access-Control-Allow-Headers: "Content-Type,Authorization"

tls:
  options:
    ondemand:
      onDemand:
        # Ask allows Traefik to check if it should issue a cert.
        # Ideally enable this and point to an API: http://dyad-server:3001/api/check-domain
        # For now, commented out to ensure it works immediately (but less secure against spam)
        # ask: http://dyad-server:3001/api/allow-cert
