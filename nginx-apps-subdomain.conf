# Nginx Configuration for Dyad App Subdomains
# File: /etc/nginx/sites-available/dyad-apps

# Wildcard server block for all app subdomains
# Matches: app66.dyad1.ty-dev.site, app67.dyad1.ty-dev.site, etc.
server {
    listen 80;
    listen 443 ssl http2;
    
    # Regex to capture app ID from subdomain
    # Matches: app-dyad-66.ty-dev.site OR app-dyad-66.dyad1.ty-dev.site
    server_name ~^app-dyad-(?<app_id>\d+)\.(?:dyad1\.)?ty-dev\.site$;

    # SSL Configuration (if using Let's Encrypt wildcard cert)
    # ssl_certificate /etc/letsencrypt/live/dyad1.ty-dev.site/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/dyad1.ty-dev.site/privkey.pem;
    
    # If using Cloudflare proxy, SSL is handled automatically
    # Just ensure Cloudflare SSL mode is "Full" or "Full (strict)"

    # Logs per app for debugging
    access_log /var/log/nginx/app-$app_id-access.log;
    error_log /var/log/nginx/app-$app_id-error.log;

    # Proxy all requests to Dyad backend
    location / {
        # Proxy to the existing internal proxy endpoint
        # Proxy to the existing internal proxy endpoint
        proxy_pass http://dyad-server:3007/api/apps/$app_id/proxy/;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Timeouts for long-running requests
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}

# Instructions:
# 1. Save this file to /etc/nginx/sites-available/dyad-apps
# 2. Create symlink: sudo ln -s /etc/nginx/sites-available/dyad-apps /etc/nginx/sites-enabled/
# 3. Test config: sudo nginx -t
# 4. Reload nginx: sudo systemctl reload nginx
#
# DNS Configuration (Cloudflare):
# 1. Go to Cloudflare DNS settings
# 2. Add record:
#    Type: A
#    Name: *.dyad1.ty-dev.site (or just *)
#    Value: <your server IP>
#    Proxy: Enabled (orange cloud)
# 3. SSL/TLS mode: Full or Full (strict)
