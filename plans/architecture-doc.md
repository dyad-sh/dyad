# ARCHITECTURE.md Documentation Plan

> Generated by swarm planning session on 2026-02-16

## Summary

Create a comprehensive ARCHITECTURE.md document that summarizes Dyad's product features, capabilities, and technical architecture. The document serves both contributors (who need to navigate the codebase) and evaluators (who need to assess technology choices), using progressive disclosure to serve both audiences effectively.

## Problem Statement

Dyad is a sophisticated Electron application with 40+ IPC handler categories, 30+ agent tools, multiple integration backends, and a nuanced process architecture. New contributors struggle to find where to make changes, and evaluators can't quickly assess the technology choices and architectural patterns without reading through scattered code. There is no single document that maps the product's capabilities to its technical implementation.

## Scope

### In Scope (MVP)

- Product overview with feature summary
- High-level architecture diagram (Mermaid) showing process boundaries
- Core systems documentation (IPC, AI/LLM, Agent, Database)
- Integration overview (Vercel, Supabase, Neon, GitHub)
- Key directory structure with entry points
- Data flow diagrams for critical paths (chat, app creation, deployment)
- Pro feature documentation (clearly labeled)
- Decision log explaining key architectural choices

### Out of Scope (Follow-up)

- Detailed API reference (belongs in code comments / generated docs)
- Contributing guide (CONTRIBUTING.md already exists)
- Deployment/ops documentation
- Per-feature deep-dive documents (can link out later)

## User Stories

- As a **potential contributor**, I want to understand the architecture so I can find the right files to modify when fixing a bug or adding a feature
- As a **technology evaluator**, I want to understand Dyad's tech stack and design decisions so I can assess whether it fits my needs
- As an **AI agent** (Claude Code, etc.), I want structured architectural context so I can navigate the codebase effectively when assisting with development tasks
- As an **existing maintainer**, I want a reference document so I can onboard new contributors faster

## UX Design (Document Structure)

### Reader Personas & Time Budgets

| Persona               | Time Budget | Needs                                      |
| --------------------- | ----------- | ------------------------------------------ |
| Casual Explorer       | 2 min       | Product overview, feature list, tech stack |
| Potential Contributor | 10-15 min   | Architecture, key paths, patterns          |
| Evaluator             | 5 min       | Tech choices, design decisions, trade-offs |
| AI Agent              | Full read   | Structured, parseable, comprehensive       |

### Document Structure (Inverted Pyramid)

```
1. Product Overview (2 min read)
   - What Dyad is (1-2 sentences)
   - Key capabilities (bullet list)
   - Tech stack summary (table)

2. Architecture Overview (3 min read)
   - Mermaid diagram: process architecture (main/renderer/worker)
   - IPC contract system explanation
   - Key architectural decisions table (decision → rationale)

3. Directory Structure (1 min scan)
   - Annotated tree of key directories
   - Entry points for each major area

4. Core Systems (8 min read, progressive sections)
   4a. IPC Layer
       - Contract types (IpcContract, EventContract, StreamContract)
       - Handler registration pattern
       - Key paths: src/ipc/contracts/, src/ipc/handlers/, src/ipc/types/

   4b. AI & LLM Integration
       - Provider abstraction (Vercel AI SDK)
       - Supported providers table
       - Prompt system overview
       - Key paths: src/ipc/utils/llm_engine_provider.ts, src/prompts/

   4c. Agent System
       - Tool categories and capabilities
       - Consent system (MCP + agent tools)
       - Tool execution flow
       - Key paths: src/ipc/handlers/ (agent tools), src/ipc/types/agent.ts

   4d. Data Layer
       - SQLite + Drizzle ORM
       - Core tables diagram (Mermaid ER)
       - Migration strategy
       - Key paths: src/db/, drizzle/

5. Frontend Architecture (3 min read)
   - React 19 + TanStack Router/Query + Jotai
   - Component organization
   - State management patterns
   - Key paths: src/components/, src/pages/, src/atoms/, src/hooks/

6. External Integrations (3 min read)
   - Vercel (deployment)
   - Supabase (backend/database)
   - Neon (PostgreSQL)
   - GitHub (source control)
   - MCP servers
   - Key paths: src/ipc/handlers/*_handlers.ts

7. Pro Features (2 min read) [Clearly labeled as Pro]
   - Visual editing
   - Plan mode
   - Local Agent v2
   - Free agent quota system

8. Key Data Flows (3 min read)
   - Chat message flow (Mermaid sequence diagram)
   - App creation flow
   - Deployment flow

9. Build & Development (2 min read)
   - Electron Forge + Vite build pipeline
   - Testing strategy (Vitest + Playwright)
   - Key scripts
   - Key paths: forge.config.ts, vite.*.config.mts, e2e-tests/

10. Design Principles
    - Link to rules/product-principles.md
    - Brief summary of how principles map to architecture
```

### Visual Elements

- **Mermaid diagrams**: Process architecture, ER diagram, sequence diagrams for data flows
- **Tables**: Tech stack, provider list, architectural decisions, tool categories
- **Annotated directory tree**: Key directories with brief descriptions
- **Labels**: Pro features clearly marked with `[Pro]` badges

### Anti-Patterns to Avoid

- No wall-of-text paragraphs — use bullets, tables, diagrams
- No deep function-level details — stay at directory/module level
- No duplicating implementation details that live in code comments
- No stale links — prefer relative paths within the repo

## Technical Design

### Architecture Decisions to Document

| Decision                | Rationale to Explain                                    |
| ----------------------- | ------------------------------------------------------- |
| Electron over web app   | Local execution, file system access, process isolation  |
| SQLite over server DB   | Local-first, no server dependency, fast for metadata    |
| Vercel AI SDK           | Provider-agnostic LLM abstraction, streaming support    |
| IPC contract system     | Type safety across process boundary, multiple patterns  |
| Drizzle ORM             | Type-safe queries, migration generation, SQLite support |
| Jotai over Redux        | Atomic state, simpler mental model, React 19 compatible |
| isomorphic-git + dugite | Cross-platform git, native perf on Windows              |

### Diagrams to Create

1. **Process Architecture** (Mermaid flowchart)
   - Electron main process → IPC → Renderer process
   - Worker threads (TSC)
   - External services (LLM APIs, Vercel, Supabase, Neon, GitHub)

2. **Database ER Diagram** (Mermaid)
   - apps → chats → messages → versions
   - language_model_providers → language_models
   - mcpServers → mcpToolConsents
   - customThemes

3. **Chat Message Flow** (Mermaid sequence)
   - User → Renderer → IPC → Main → LLM API → streaming back
   - Tool call → consent check → execution → response

4. **IPC Contract Types** (Mermaid class/flowchart)
   - IpcContract, EventContract, StreamContract patterns

### Files Affected

- **New file**: `ARCHITECTURE.md` at repo root
- **No other files need changes** — this is a pure documentation addition

### Maintainability Strategy

- Reference directory paths (e.g., `src/ipc/handlers/`) not specific files
- Link to existing docs (README, CONTRIBUTING, product-principles) rather than duplicating
- Include "last updated" date at bottom
- Keep Mermaid diagrams simple enough to update without specialized tools

## Implementation Plan

### Phase 1: Write ARCHITECTURE.md

- [ ] Create product overview section with capabilities and tech stack
- [ ] Create process architecture Mermaid diagram
- [ ] Write IPC system section with contract types
- [ ] Write AI/LLM integration section with provider table
- [ ] Write agent system section with tool categories
- [ ] Write data layer section with ER diagram
- [ ] Write frontend architecture section
- [ ] Write external integrations section
- [ ] Write Pro features section (labeled)
- [ ] Create data flow sequence diagrams
- [ ] Write build & development section
- [ ] Add design principles reference
- [ ] Write annotated directory structure

### Phase 2: Review & Polish (Follow-up)

- [ ] Verify all directory paths are current
- [ ] Test Mermaid diagrams render on GitHub
- [ ] Cross-reference with README for consistency
- [ ] Get feedback from a new contributor (usability test)

## Testing Strategy

- [ ] Verify Mermaid diagrams render correctly on GitHub
- [ ] Check all relative links resolve
- [ ] Have someone unfamiliar with the codebase read it and note confusion points
- [ ] Verify directory paths mentioned actually exist

## Risks & Mitigations

| Risk                          | Likelihood | Impact | Mitigation                                                           |
| ----------------------------- | ---------- | ------ | -------------------------------------------------------------------- |
| Document becomes stale        | H          | M      | Use directory paths not file names; add "last updated" date          |
| Too long/overwhelming         | M          | M      | Progressive disclosure structure; clear section headers for scanning |
| Inaccurate technical details  | L          | H      | Cross-reference with actual code during writing                      |
| Mermaid diagrams don't render | L          | L      | Keep diagrams simple; test on GitHub before merging                  |

## Open Questions

- Should the document include performance characteristics or benchmarks? (Probably not for v1 — too volatile)
- Should there be a "Glossary" section for Dyad-specific terminology? (Nice to have, can add later)

## Decision Log

| Decision                   | Reasoning                                                                                  |
| -------------------------- | ------------------------------------------------------------------------------------------ |
| Both audiences equally     | Progressive disclosure serves both — quick scan for evaluators, deep read for contributors |
| Include Pro features       | Completeness matters; labeled sections prevent confusion about what's open-source          |
| Conceptual + key paths     | Right balance — directory-level paths help navigation without creating maintenance burden  |
| Mermaid diagrams           | GitHub renders them natively; easier to maintain than ASCII art                            |
| Single file, not split     | ARCHITECTURE.md as single comprehensive doc; can split later if it grows too large         |
| Inverted pyramid structure | Serves time-constrained readers first, completionists second                               |

---

_Generated by dyad:swarm-to-plan_
